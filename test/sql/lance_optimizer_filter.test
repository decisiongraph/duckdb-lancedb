# name: test/sql/lance_optimizer_filter.test
# description: Test optimizer filter pushdown for WHERE clauses on Lance index scans
# group: [lance]

require lancedb

# Create table with vectors and metadata
statement ok
CREATE TABLE docs (id INT, lang VARCHAR, score INT, embedding FLOAT[3]);

statement ok
INSERT INTO docs VALUES
  (1, 'en', 10, [1.0, 0.0, 0.0]),
  (2, 'fr', 20, [0.9, 0.1, 0.0]),
  (3, 'es', 30, [0.0, 0.0, 1.0]),
  (4, 'en', 40, [0.0, 1.0, 0.0]),
  (5, 'en', 50, [0.5, 0.5, 0.0]);

# Multi-column LANCE index
statement ok
CREATE INDEX docs_idx ON docs USING LANCE (embedding, lang, score);

# Basic filter pushdown: WHERE lang = 'en' should be pushed to Lance
query I
SELECT d.id
FROM docs d
WHERE d.lang = 'en'
ORDER BY array_distance(d.embedding, [1.0, 0.0, 0.0]::FLOAT[3])
LIMIT 3;
----
1
5
4

# Numeric comparison filter
query I
SELECT d.id
FROM docs d
WHERE d.score > 20
ORDER BY array_distance(d.embedding, [1.0, 0.0, 0.0]::FLOAT[3])
LIMIT 2;
----
5
4

# Without filter: top 2 nearest to [1,0,0]
query I
SELECT d.id
FROM docs d
ORDER BY array_distance(d.embedding, [1.0, 0.0, 0.0]::FLOAT[3])
LIMIT 2;
----
1
2

# Filter that excludes all but one row
query I
SELECT d.id
FROM docs d
WHERE d.lang = 'es'
ORDER BY array_distance(d.embedding, [1.0, 0.0, 0.0]::FLOAT[3])
LIMIT 5;
----
3

# IS NOT NULL pushdown â€” all 5 rows returned, top 3 are deterministic
query I
SELECT d.id
FROM docs d
WHERE d.lang IS NOT NULL
ORDER BY array_distance(d.embedding, [1.0, 0.0, 0.0]::FLOAT[3])
LIMIT 3;
----
1
2
5

# IN pushdown
query I
SELECT d.id
FROM docs d
WHERE d.lang IN ('en', 'fr')
ORDER BY array_distance(d.embedding, [1.0, 0.0, 0.0]::FLOAT[3])
LIMIT 3;
----
1
2
5

# NOT + comparison pushdown
query I
SELECT d.id
FROM docs d
WHERE NOT (d.lang = 'en')
ORDER BY array_distance(d.embedding, [1.0, 0.0, 0.0]::FLOAT[3])
LIMIT 2;
----
2
3
